<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
	</head>

	<body></body>
	<script>
		class MyPromise {
			constructor(createFunc) {
				this.status = 'pending' // fulfilled rejected
				this.value = null
				this.reason = null
				this.resolveEvent = null
				this.rejectEvent = null
				this.setResolve = value => {
					if (this.status === 'pending') {
						this.status = 'fulfilled'
						this.value = value
						this.resolveEvent && this.resolveEvent(value)
					}
				}
				this.setReject = reason => {
					if (this.status === 'pending') {
						this.status = 'rejected'
						this.reason = reason
						this.rejectEvent && this.rejectEvent(reason)
					}
				}

				if (!createFunc) {
					throw new TypeError('Promise resolver undefined is not a function')
				}

				try {
					createFunc(this.setResolve, this.setReject)
				} catch (reason) {
					this.setReject(reason)
				}
			}

			then(resolveFunc, rejectFunc) {
				return new MyPromise((resolve, reject) => {
					const resolveEvent = () => {
						try {
							if (typeof resolveFunc === 'function') {
								this.excuteChildPromise(resolveFunc(this.value), resolve, reject)
							} else {
								resolve(this.value)
							}
						} catch (reason) {
							reject(reason)
						}
					}
					const rejectEvent = () => {
						try {
							if (typeof rejectFunc === 'function') {
								this.excuteChildPromise(rejectFunc(this.reason), resolve, reject)
							} else {
								reject(this.reason)
							}
						} catch (reason) {
							reject(reason)
						}
					}

					if (this.status === 'pending') {
						this.resolveEvent = resolveEvent
						this.rejectEvent = rejectEvent
					} else if (this.status === 'fulfilled') {
						resolveEvent()
					} else if (this.status === 'rejected') {
						rejectEvent()
					}
				})
			}

			excuteChildPromise(childPromise, resolve, reject) {
				if (childPromise instanceof MyPromise) {
					childPromise.then(
						childValue => {
							this.excuteChildPromise(childValue, resolve, reject)
						},
						childReason => {
							reject(childReason)
						}
					)
				} else {
					resolve(childPromise)
				}
			}

			catch(rejectFunc) {
				return this.then(null, rejectFunc)
			}

			static resolve(param) {
				if (param instanceof MyPromise) return param
				return new MyPromise(resolve => resolve(param))
			}

			static reject(param) {
				return new MyPromise((resolve, reject) => reject(param))
			}

			static all(array) {
				let resultArray = []

				return new MyPromise((resolve, reject) => {
					if (array.length === 0) {
						resolve(resultArray)
					} else {
						array.forEach(promise => {
							MyPromise.resolve(promise)
								.then(value => {
									resultArray.push(value)
									resultArray.length === array.length && resolve(resultArray)
								})
								.catch(reject)
						})
					}
				})
			}

			static race(array) {
				return new MyPromise((resolve, reject) => {
					array.forEach(promise => {
						MyPromise.resolve(promise).then(resolve).catch(reject)
					})
				})
			}
		}

		var p1 = new MyPromise(function (resolve) {
			setTimeout(() => {
				resolve('fulfilled')
			}, 200)
		})
		var p2 = new MyPromise(function (resolve, reject) {
			setTimeout(() => {
				reject('rejected')
			}, 100)
		})
		console.log(MyPromise.race([p1, p2]))
		MyPromise.race([p1, p2])
			.then(value => {
				console.log(value)
			})
			.catch(function (reason) {
				console.log(reason) //"rejected"
			})

		// let realPromise = new MyPromise((resolve, reject) => {
		// 	setTimeout(() => {
		// 		reject('success')
		// 	}, 500)
		// })
		// 	// .then(
		// 	// 	value => {
		// 	// 		console.log('then0: ', value)
		// 	// 		throw new Error('childError000')
		// 	// 		return value
		// 	// 	},
		// 	// 	reason => {
		// 	// 		console.log('reject0: ', reason)
		// 	// 		throw new Error('childError000')
		// 	// 		return reason
		// 	// 	}
		// 	// )
		// 	.then(
		// 		value => {
		// 			console.log('then1: ', value)
		// 			// return value
		// 			return new MyPromise((resolve, reject) => {
		// 				throw new Error('childError222')
		// 				reject('childError')
		// 			})
		// 				.then(
		// 					value => {
		// 						console.log('childThen: ', value)
		// 						return value
		// 					},
		// 					reason => {
		// 						console.log('childReject: ', reason)
		// 						return reason
		// 					}
		// 				)
		// 				.catch(reason => {
		// 					console.log('childCatch: ', reason)
		// 					return reason
		// 				})
		// 		},
		// 		reason => {
		// 			console.log('then1Reject: ', reason)
		// 			// throw new Error('childError333')
		// 			// return reason
		// 			return new MyPromise((resolve, reject) => {
		// 				// throw new Error('childError333')
		// 				reject('childError')
		// 			}).then(
		// 				value => {
		// 					console.log('childThen: ', value)
		// 					return value
		// 				},
		// 				reason => {
		// 					console.log('childReject: ', reason)
		// 					return reason
		// 				}
		// 			)
		// 			// .catch(reason => {
		// 			// 	console.log('childCatch: ', reason)
		// 			// 	return reason
		// 			// })
		// 		}
		// 	)
		// 	// .then(value => {
		// 	// 	console.log('then2: ', value)
		// 	// 	return value
		// 	// })
		// 	// .catch(reason => {
		// 	// 	console.log('rootCatch: ', reason)
		// 	// 	throw new Error('123')
		// 	// 	return reason
		// 	// 	return new Promise((res, rej) => {
		// 	// 		res('123')
		// 	// 	})
		// 	// })
		// 	// .then(
		// 	// 	value => {
		// 	// 		console.log(111, value)
		// 	// 		return value
		// 	// 	},
		// 	// 	reason => {
		// 	// 		console.log('error: ', reason)
		// 	// 		return reason
		// 	// 	}
		// 	// )
		// 	// .then(value => {
		// 	// 	console.log(333, value)
		// 	// 	return value
		// 	// })
		// 	.catch(reason => {
		// 		console.log(222, reason)
		// 		return reason
		// 	})
		// // .catch(reason => {
		// // 	console.log(444, reason)
		// // })
	</script>
	<!-- <script>
		setTimeout(() => {
			console.log(0)
		})

		new Promise(resolve => {
			console.log(1)

			setTimeout(() => {
				resolve()
				Promise.resolve().then(() => {
					console.log(2)
					setTimeout(() => console.log(3))
					Promise.resolve().then(() => console.log(4))
				})
			})

			Promise.resolve().then(() => console.log(5))
		}).then(() => {
			console.log(6)
			Promise.resolve().then(() => console.log(7))
			setTimeout(() => console.log(8))
		})

		console.log(9)

		h: []
		w: []
		1
		9
		5
		0
		6
		2
		7
		4
		8
		3
	</script> -->
</html>
