# 前端基础建设

## 一、i18n 多语言需求提效方案

#### 过去的多语言方案：

![image](https://img.alicdn.com/imgextra/i2/O1CN01CxQRW91HKVenYSSO3_!!6000000000739-0-tps-2410-1828.jpg)

&emsp;&emsp;通过美杜莎（阿里内部的多语言配置平台）node 程序，从代码中提取引用的 key，根据 key 在本地项目中生成一个多语言 json 文件，json 文件会和项目源码合并打包发布到线上

&emsp;&emsp;这种方式会带来 2 个问题：

&emsp;&emsp;1、运营同学想改页面上的文案，但是他并不知道这个文案对应的多语言 key 是那个，每次都要问前端同学，然后前端同学又专门翻代码去查这个 key；或者前端同学每开发一个项目时，要将该项目用到的所有 key 及对应的文案、截图做一个 excel 表格，当运营同学想改文案时，自己去查阅这个表格，前端同学在迭代项目时也要记得同时维护这个表格

![image](https://img.alicdn.com/imgextra/i4/O1CN01XXJTLI1gJ0kwX4k4J_!!6000000004120-0-tps-2722-1810.jpg)

&emsp;&emsp;2、由于多语言的 json 文件是和源码在一起的，运营同学每改一次多语言配置，前端同学还得新建一个迭代，把新的多语言 json 文件拉到本地，然后发布一次线上

#### 提效方案：

&emsp;&emsp;**关于问题 1，运营同学查询多语言 key 的解法**

&emsp;&emsp;在一次与外部团队的交流中，发现他们新开发了一个浏览器多语言插件，前端同学在源码中按照特定的方式引入多语言 key 后，将这个插件给到运营同学，安装在浏览器上并打开后，可以在页面上直接显示出对应文案的多语言配置地址，无需再去问相关前端同学或查询 excel 表格

![image](https://img.alicdn.com/imgextra/i4/O1CN01Xe1CnS28m9C39NzaU_!!6000000007974-0-tps-3308-2158.jpg)

&emsp;&emsp;**关于问题 2，每次改多语言文案都要发布一次页面的解法**

&emsp;&emsp;当用户请求某个 url 时，请求信息会走到 Node Portal 服务器，服务器会根据 url 返回对应的 index.html 文件

&emsp;&emsp;那么 Node Portal 服务器在返回 html 文件前，请求多语言服务器，获取这个页面的所有多语言 json 信息，将其变成对象，写入 html 文件（类似于服务端渲染），如此就可以实时的获取最新的多语言文案

![image](https://img.alicdn.com/imgextra/i1/O1CN01aO1L2j21kaXAQc93o_!!6000000007023-0-tps-3308-2158.jpg)

&emsp;&emsp;并且由于获取最新 json 信息的步骤由 Node Portal 服务器自动完成，而不是本地源码开发时手动获取，因此当运营同学改变文案时，前端无需在本地拉取最新 json 信息，然后重发一遍页面，运营同学改完后，线上就能够自动生效

#### 提效后的结果：

&emsp;&emsp;运营同学想改变文案时，在当前页面打开插件，点击页面上对应文案的配置链接，在多语言平台发布文案后，刷新页面即可看到最新文案，全程不需要前端同学的参与

## 二、迁移至 DaDa2.0 发布平台

#### DaDa1.0 发布平台

&emsp;&emsp;仅具备单个页面的预发、线上发布、回滚功能，js 和 css 文件配置后被插入在 HTML 的固定位置（无法编辑 HTML 模版），无法灰度发布，无法批量发布，发布平台对业务页面有侵入性（用户打开一个页面时会先跑一段发布平台的逻辑，由该逻辑拉取真正的页面内容）

&emsp;&emsp;总之 1.0 平台，除了能发布和回滚页面这 2 个基础功能外，再无其他好处了

&emsp;&emsp;（由于该发布平台的规定，无法截图给大家看）

#### DaDa2.0 发布平台

&emsp;&emsp;在一次反馈 DaDa1.0 平台问题时，得知该项目组正在开发 DaDa2.0 发布平台，我很感兴趣，找项目组要了新平台的测试账号，经过试用后，我发现 2.0 相比 1.0 有了质的飞跃

&emsp;&emsp;2.0 平台新增了批量发布、HTML 模版半自由配置、全局变量等功能，并且发布平台代码不再侵入业务页面，美中不足的是回滚功能被取消了

&emsp;&emsp;新增功能中我最中意的是 HTML 模版半自由配置，也就是在 HTML 上给了 4 个位置可以插入任意代码，分别是 head 标签的最上方和最下方，body 标签的最上方和最下方

&emsp;&emsp;虽说是半自由，但能控制一部分 HTML 代码，对于前端同学来说便有了很多的操作空间，例如：配置 meta 标签、设置 css 全局样式、在业务代码前先加载监控平台的 js 文件、在业务代码前预请求数据等等

![image](https://img.alicdn.com/imgextra/i1/O1CN0173YTaS1cXQlKZe1r1_!!6000000003610-0-tps-3308-2158.jpg)
![image](https://img.alicdn.com/imgextra/i1/O1CN0154wlXg1YfRDxlaQAv_!!6000000003086-0-tps-3308-2158.jpg)

#### 迁移的成果

&emsp;&emsp;我在自己负责的业务域中进行迁移实验，得出 3 点主要好处：

&emsp;&emsp;1、DaDa1.0 的 html 模版不能自己配置，导致之前要换监控平台、埋点平台等需要动 html 模版的需求，需要联系负责 html 模版的中台（跟 DaDa 团队还不是一个团队）去改 Java 的 VM 模版，每改一次 html 模版的沟通成本，加上提工单、排期、走流程的时间，往往要 1 个多星期。换成 DaDa2.0 后，就不需要再去找中台改东西了，节省了这部分需求所花费的时间

&emsp;&emsp;2、发布平台不再有侵入性，我们负责的南亚 5 国由于机房距离远，当地网络基建差等原因，任何一个请求从发出到回来平均有 500ms 的延迟。dada1.0 的页面渲染逻辑是，页面先请求 dada 平台的 js 文件，js 文件分析了当前页面要渲染什么内容后，再去请求真正的业务 js 文件，这就导致 dada1.0 发布的任何页面，天生自带 500ms 的白屏时间。换成 DaDa2.0 后，相当于给所有页面做了一次性能优化

&emsp;&emsp;3、可以批量发布页面，一般一个业务域的所有页面集中在一个代码仓库中，当有涉及多个页面的改动时也需要发布多个页面，dada1.0 只能一个一个页面的发布，每发布一个页面，构建、发预发、发线上、审批都需要耗费十几分钟的时间。换成 DaDa2.0 后，就可以只走一次发布流程，而发布同仓库的多个页面，节省了前端同学在多页面发布上所耗费的时间

&emsp;&emsp;虽说 2.0 平台还无法满足前端同学理想中的全部功能，但是久旱逢甘霖，对比 1.0 所带来的提升，已经足够我们花费时间迁移过去了。在我负责域的页面实验成功后，团队内的同学也纷纷迁移到了 2.0 平台

## 三、迁移至 Lago 发布平台

&emsp;&emsp;上文叙述到，DaDa2.0 平台虽然比 1.0 提升了不少，但是仍然不够理想，在 Dada2.0 发布 1 年多后，同样使用 2.0 的另一支国际化电商团队，自研了一款发布平台 - Lago 平台

#### Lago 平台的优势

&emsp;&emsp;Lago 平台吸取了前人的经验，对发布平台的架构进行了重新设计，使得前端团队对发布的掌控度达到了空前的高度

&emsp;&emsp;Lago 在集团网络架构的位置：

![image](https://img.alicdn.com/imgextra/i1/O1CN01kiMqsD1nbW4NC4Yjz_!!6000000005108-0-tps-2652-1396.jpg)

&emsp;&emsp;对比 DaDa2.0 来说，简单的示意图如下：

![image](https://img.alicdn.com/imgextra/i4/O1CN01IMiwNz1lZ6kn5nvMt_!!6000000004832-0-tps-2126-774.jpg)

&emsp;&emsp;架构上的改变带来了 2 点主要优势

&emsp;&emsp;**1、由中台团队掌管的 Java 应用变成了业务方自己的前端团队掌握的 Node 应用：**

&emsp;&emsp;&emsp;&emsp;a. 从此三方合作变成了前端团队与 lago 团队的两方合作，大大减少了沟通成本；

&emsp;&emsp;&emsp;&emsp;b. 由于 Node 应用的出现，前端团队拥有了后端的力量，诸如服务端渲染、用户权限控制、页面重定向、多语言实时更新等能力都能够自由开发，从此不求人，前端团队的能力范围及研发效率有了质的提升

&emsp;&emsp;**2、Lago 平台替代了 DaDa 平台，Lago 平台针对 DaDa 平台的缺陷进行了针对性的改进，并且将前端所需的发布平台能力进行了大量扩充：**

&emsp;&emsp;&emsp;&emsp;a. 诸如新增了页面灰度的能力，能够并行国家、百分比、白名单三种方式进行灰度；

&emsp;&emsp;&emsp;&emsp;b. HTML 模版完全自定义，还可创建多个模版，不同页面使用不同的模版；

&emsp;&emsp;&emsp;&emsp;c. 可创建 OSC 配置，一个给运营同学用的配置功能，会生成一个 JSON 文件自动注入到页面中，通常配置一些正则、页面组件等；

&emsp;&emsp;&emsp;&emsp;d. Npm 依赖包管理，一般来说 Npm 包的版本是写在源码的 package.json 里的，一旦打包就把代码合并进了源码无法改变了，这个包管理可以在 Lago 平台动态的改变包版本，而无需重新发布代码，当然源码也要进行适当的改造，动态引入 Npm 包；

&emsp;&emsp;&emsp;&emsp;e. 新增子站点功能，能够自由增加四级域名

&emsp;&emsp;&emsp;&emsp;f. 优化了内部的发布链路，发布预发环境和线上环境时几乎可以做到秒发

&emsp;&emsp;&emsp;&emsp;g. 增加了回滚功能，所有能发布的全局变量、模版、Npm 包、页面都能够回滚

![image](https://img.alicdn.com/imgextra/i1/O1CN01QeVjeR1M50KLEuKsR_!!6000000001382-0-tps-3308-2158.jpg)
![image](https://img.alicdn.com/imgextra/i2/O1CN01i5EY3E1XeEZ8lom4v_!!6000000002948-0-tps-3308-2158.jpg)
![image](https://img.alicdn.com/imgextra/i1/O1CN01EyuVrM1Whbs2V5S0m_!!6000000002820-0-tps-3308-2158.jpg)
![image](https://img.alicdn.com/imgextra/i2/O1CN01l1Rrlo1F3u3yVsjrc_!!6000000000432-0-tps-3308-2158.jpg)
![image](https://img.alicdn.com/imgextra/i3/O1CN01pEzHst1YDxSd5D9D3_!!6000000003026-0-tps-3308-2158.jpg)

#### 迁移的成果
